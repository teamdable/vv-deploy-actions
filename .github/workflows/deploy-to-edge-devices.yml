name: deploy to edge device

on:
  workflow_call:
    inputs:
      user:
        description: edge device username
        required: true
        type: string
      code-name:
        description: code module name
        required: true
        type: string
    secrets:
      tailscale-authkey:
        description: tailscale authkey to add runner to the tailnet
        required: true
      password:
        description: edge device password
        required: true
      otp:
        description: edge device otp
        required: true

jobs:
  deploy-and-install:
    name: deploy-and-install
    runs-on: ubuntu-20.04
    steps:
      - name: Add runner to the tailnet
        uses: tailscale/github-action@v1
        with:
          authkey: ${{ secrets.tailscale-authkey }}
      
      - name: Checkout the deploy-target repository
        uses: actions/checkout@v2

      - name: Checkout the action repository
        uses: actions/checkout@v2
        with:
          repository: teamdable/vv-deploy-actions
          path: action/
      
      - name: Setup python 3.8
        uses: actions/setup-python@v2
        with:
          python-version: 3.8

      - name: Install pandas,requests for api call
        run: |
          python3 -m pip install --upgrade pip
          pip install -r action/requirements.txt

      - name: Get VPN IP of deploy-target devices
        run: | 
          python3 action/get-vpn-ip

      - name: Build
        run: |
          suffix=$(date '+%Y-%m-%d_%H:%M:%S')
          zip_file_name="${{ inputs.code-name }}-${suffix}.zip"
          echo "ZIP_FILE_NAME=$zip_file_name" >> $GITHUB_ENV

          git archive --format=zip main -o $zip_file_name
          zip --delete $zip_file_name ".github/*" 


      - name: Deploy & Install
        run: |
          sudo apt-get install expect oathtool
          action/deploy-to-edge-devices.sh ${{ inputs.user }} ${{ secrets.password }} ${{ secrets.otp }} ${{ env.ZIP_FILE_NAME }} ${{ inputs.code-name }}
